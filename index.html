<html><head><base href="https://webapps.example.com/"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>APP FICHAJES</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/flatpickr"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script><style>
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f8f9fa;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    .btn-primary {
        background-color: #4a90e2;
        border-color: #4a90e2;
    }
    .btn-primary:hover {
        background-color: #3a78c2;
        border-color: #3a78c2;
    }
    .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }
    .card-header {
        background-color: #4a90e2;
        color: white;
        border-radius: 8px 8px 0 0;
    }
    .form-control:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
    }
</style></head><body>
<div class="container">
    <h1 class="text-center mb-4">APP FICHAJES</h1>
    <div class="row mb-3">
        <div class="col-6">
            <button id="addCompanyBtn" class="btn btn-primary w-100">Agregar Empresa</button>
        </div>
        <div class="col-6">
            <button id="viewCompaniesBtn" class="btn btn-primary w-100">Ver Empresas</button>
        </div>
    </div>
    <div id="companyForm" class="card d-none">
        <div class="card-header">
            <h5 class="card-title mb-0">Agregar Empresa</h5>
        </div>
        <div class="card-body">
            <form id="addCompanyForm">
                <div class="mb-3">
                    <label for="companyName" class="form-label">Nombre de la Empresa</label>
                    <input type="text" class="form-control" id="companyName" required>
                </div>
                <div class="mb-3">
                    <label for="companyCIF" class="form-label">CIF</label>
                    <input type="text" class="form-control" id="companyCIF" required>
                </div>
                <div class="mb-3">
                    <label for="companyAddress" class="form-label">Dirección</label>
                    <input type="text" class="form-control" id="companyAddress" required>
                </div>
                <div class="mb-3">
                    <label for="companyPostalCode" class="form-label">Código Postal</label>
                    <input type="text" class="form-control" id="companyPostalCode" required>
                </div>
                <div class="mb-3">
                    <label for="companyCity" class="form-label">Ciudad</label>
                    <input type="text" class="form-control" id="companyCity" required>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Empresa</button>
            </form>
        </div>
    </div>
    <div id="companiesList" class="d-none">
        <h2 class="mb-3">Lista de Empresas</h2>
        <div id="companiesContainer"></div>
    </div>
    <div id="employeeForm" class="card d-none">
        <div class="card-header">
            <h5 class="card-title mb-0">Agregar/Editar Empleado</h5>
        </div>
        <div class="card-body">
            <form id="addEmployeeForm">
                <div class="mb-3">
                    <label for="employeeName" class="form-label">Nombre del Empleado</label>
                    <input type="text" class="form-control" id="employeeName" required>
                </div>
                <div class="mb-3">
                    <label for="employeeDNI" class="form-label">DNI</label>
                    <input type="text" class="form-control" id="employeeDNI" required>
                </div>
                <div class="mb-3">
                    <label for="employeeSocialSecurity" class="form-label">Número de Seguridad Social</label>
                    <input type="text" class="form-control" id="employeeSocialSecurity" required>
                </div>
                <div id="scheduleInputs"></div>
                <button type="submit" class="btn btn-primary">Guardar Empleado</button>
            </form>
        </div>
    </div>
    <div id="employeesList" class="d-none">
        <h2 class="mb-3">Lista de Empleados</h2>
        <div id="employeesContainer"></div>
    </div>
    <div id="vacationForm" class="card d-none">
        <div class="card-header">
            <h5 class="card-title mb-0">Agregar/Editar Vacaciones</h5>
        </div>
        <div class="card-body">
            <form id="addVacationForm">
                <div class="mb-3">
                    <label for="vacationStart" class="form-label">Fecha de Inicio</label>
                    <input type="text" class="form-control" id="vacationStart" required>
                </div>
                <div class="mb-3">
                    <label for="vacationEnd" class="form-label">Fecha de Fin</label>
                    <input type="text" class="form-control" id="vacationEnd" required>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Vacaciones</button>
            </form>
        </div>
    </div>
    <div id="generateTimecardsForm" class="card d-none">
        <div class="card-header">
            <h5 class="card-title mb-0">Generar Fichajes</h5>
        </div>
        <div class="card-body">
            <form id="generateTimecardsForm">
                <div class="mb-3">
                    <label for="selectEmployee" class="form-label">Seleccionar Empleado</label>
                    <select class="form-select" id="selectEmployee" required></select>
                </div>
                <div class="mb-3">
                    <label for="timecardsStart" class="form-label">Fecha de Inicio</label>
                    <input type="text" class="form-control" id="timecardsStart" required>
                </div>
                <div class="mb-3">
                    <label for="timecardsEnd" class="form-label">Fecha de Fin</label>
                    <input type="text" class="form-control" id="timecardsEnd" required>
                </div>
                <button type="submit" class="btn btn-primary">Generar PDF</button>
            </form>
        </div>
    </div>
</div>

<script>
let companies = [];
let currentCompany = null;
let currentEmployeeIndex = null;

function saveData() {
    localStorage.setItem('companies', JSON.stringify(companies));
}

function loadData() {
    const storedCompanies = localStorage.getItem('companies');
    if (storedCompanies) {
        companies = JSON.parse(storedCompanies);
    }
}

loadData();

document.getElementById('addCompanyBtn').addEventListener('click', () => {
    document.getElementById('companyForm').classList.remove('d-none');
    document.getElementById('companiesList').classList.add('d-none');
    document.getElementById('employeeForm').classList.add('d-none');
    document.getElementById('employeesList').classList.add('d-none');
    document.getElementById('vacationForm').classList.add('d-none');
    document.getElementById('generateTimecardsForm').classList.add('d-none');
});

document.getElementById('viewCompaniesBtn').addEventListener('click', () => {
    document.getElementById('companyForm').classList.add('d-none');
    document.getElementById('companiesList').classList.remove('d-none');
    document.getElementById('employeeForm').classList.add('d-none');
    document.getElementById('employeesList').classList.add('d-none');
    document.getElementById('vacationForm').classList.add('d-none');
    document.getElementById('generateTimecardsForm').classList.add('d-none');
    displayCompanies();
});

document.getElementById('addCompanyForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const company = {
        name: document.getElementById('companyName').value,
        cif: document.getElementById('companyCIF').value,
        address: document.getElementById('companyAddress').value,
        postalCode: document.getElementById('companyPostalCode').value,
        city: document.getElementById('companyCity').value,
        employees: []
    };
    companies.push(company);
    saveData();
    document.getElementById('addCompanyForm').reset();
    alert('Empresa agregada con éxito');
});

function displayCompanies() {
    const container = document.getElementById('companiesContainer');
    container.innerHTML = '';
    companies.forEach((company, index) => {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">${company.name}</h5>
                <p class="card-text">CIF: ${company.cif}</p>
                <p class="card-text">Dirección: ${company.address}, ${company.postalCode} ${company.city}</p>
                <button class="btn btn-primary me-2" onclick="viewEmployees(${index})">Ver Empleados</button>
                <button class="btn btn-danger" onclick="deleteCompany(${index})">Eliminar Empresa</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function deleteCompany(index) {
    if (confirm('¿Estás seguro de que quieres eliminar esta empresa?')) {
        companies.splice(index, 1);
        saveData();
        displayCompanies();
    }
}

function viewEmployees(companyIndex) {
    currentCompany = companies[companyIndex];
    document.getElementById('companiesList').classList.add('d-none');
    document.getElementById('employeesList').classList.remove('d-none');
    displayEmployees();
}

function displayEmployees() {
    const container = document.getElementById('employeesContainer');
    container.innerHTML = `
        <button class="btn btn-primary mb-3" onclick="showAddEmployeeForm()">Agregar Empleado</button>
        <button class="btn btn-primary mb-3 ms-2" onclick="showGenerateTimecardsForm()">Generar Fichajes</button>
    `;
    currentCompany.employees.forEach((employee, index) => {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">${employee.name}</h5>
                <p class="card-text">DNI: ${employee.dni}</p>
                <p class="card-text">Número de Seguridad Social: ${employee.socialSecurity}</p>
                <button class="btn btn-primary me-2" onclick="editEmployee(${index})">Editar Empleado</button>
                <button class="btn btn-success me-2" onclick="showAddVacationForm(${index})">Agregar Vacaciones</button>
                <button class="btn btn-info me-2" onclick="viewVacations(${index})">Ver Vacaciones</button>
                <button class="btn btn-danger" onclick="deleteEmployee(${index})">Eliminar Empleado</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function showAddEmployeeForm() {
    currentEmployeeIndex = null;
    document.getElementById('employeesList').classList.add('d-none');
    document.getElementById('employeeForm').classList.remove('d-none');
    document.getElementById('addEmployeeForm').reset();
    generateScheduleInputs();
}

function generateScheduleInputs() {
    const container = document.getElementById('scheduleInputs');
    container.innerHTML = '';
    const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
    days.forEach(day => {
        container.innerHTML += `
            <div class="mb-3">
                <label class="form-label">${day}</label>
                <div class="row">
                    <div class="col">
                        <input type="time" class="form-control" id="${day.toLowerCase()}Start">
                    </div>
                    <div class="col">
                        <input type="time" class="form-control" id="${day.toLowerCase()}End">
                    </div>
                </div>
            </div>
        `;
    });
}

document.getElementById('addEmployeeForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const employee = {
        name: document.getElementById('employeeName').value,
        dni: document.getElementById('employeeDNI').value,
        socialSecurity: document.getElementById('employeeSocialSecurity').value,
        schedule: {},
        vacations: []
    };
    const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
    days.forEach(day => {
        const startElement = document.getElementById(`${day}Start`);
        const endElement = document.getElementById(`${day}End`);
        if (startElement && endElement) {
            const start = startElement.value;
            const end = endElement.value;
            if (start && end) {
                employee.schedule[day] = { start, end };
            }
        }
    });
    if (currentEmployeeIndex !== null) {
        currentCompany.employees[currentEmployeeIndex] = employee;
    } else {
        currentCompany.employees.push(employee);
    }
    saveData();
    document.getElementById('addEmployeeForm').reset();
    alert('Empleado guardado con éxito');
    document.getElementById('employeeForm').classList.add('d-none');
    document.getElementById('employeesList').classList.remove('d-none');
    displayEmployees();
});

function deleteEmployee(index) {
    if (confirm('¿Estás seguro de que quieres eliminar este empleado?')) {
        currentCompany.employees.splice(index, 1);
        saveData();
        displayEmployees();
    }
}

function editEmployee(index) {
    currentEmployeeIndex = index;
    const employee = currentCompany.employees[index];
    document.getElementById('employeesList').classList.add('d-none');
    document.getElementById('employeeForm').classList.remove('d-none');
    document.getElementById('employeeName').value = employee.name;
    document.getElementById('employeeDNI').value = employee.dni;
    document.getElementById('employeeSocialSecurity').value = employee.socialSecurity;
    generateScheduleInputs();
    const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
    days.forEach(day => {
        if (employee.schedule[day]) {
            const startElement = document.getElementById(`${day}Start`);
            const endElement = document.getElementById(`${day}End`);
            if (startElement && endElement) {
                startElement.value = employee.schedule[day].start;
                endElement.value = employee.schedule[day].end;
            }
        }
    });
}

function showAddVacationForm(employeeIndex) {
    document.getElementById('employeesList').classList.add('d-none');
    document.getElementById('vacationForm').classList.remove('d-none');
    flatpickr("#vacationStart", {
        dateFormat: "Y-m-d"
    });
    flatpickr("#vacationEnd", {
        dateFormat: "Y-m-d"
    });
    document.getElementById('addVacationForm').onsubmit = (e) => {
        e.preventDefault();
        const vacation = {
            start: document.getElementById('vacationStart').value,
            end: document.getElementById('vacationEnd').value
        };
        currentCompany.employees[employeeIndex].vacations.push(vacation);
        saveData();
        alert('Vacaciones agregadas con éxito');
        document.getElementById('addVacationForm').reset();
        document.getElementById('vacationForm').classList.add('d-none');
        document.getElementById('employeesList').classList.remove('d-none');
        displayEmployees();
    };
}

function viewVacations(employeeIndex) {
    const employee = currentCompany.employees[employeeIndex];
    let vacationsList = 'Vacaciones:';
    if (employee.vacations.length === 0) {
        vacationsList += '\nNo hay vacaciones registradas.';
    } else {
        employee.vacations.forEach((vacation, index) => {
            vacationsList += `\n${index + 1}. Desde ${vacation.start} hasta ${vacation.end}`;
        });
    }
    alert(vacationsList);
}

function showGenerateTimecardsForm() {
    document.getElementById('employeesList').classList.add('d-none');
    document.getElementById('generateTimecardsForm').classList.remove('d-none');
    const selectEmployee = document.getElementById('selectEmployee');
    selectEmployee.innerHTML = '';
    currentCompany.employees.forEach((employee, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = employee.name;
        selectEmployee.appendChild(option);
    });
    flatpickr("#timecardsStart", {
        dateFormat: "Y-m-d"
    });
    flatpickr("#timecardsEnd", {
        dateFormat: "Y-m-d"
    });
}

document.getElementById('generateTimecardsForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const employeeIndex = document.getElementById('selectEmployee').value;
    const startDate = new Date(document.getElementById('timecardsStart').value);
    const endDate = new Date(document.getElementById('timecardsEnd').value);
    const employee = currentCompany.employees[employeeIndex];
    const timecards = generateTimecards(employee, startDate, endDate);
    generatePDF(employee, timecards);
});

function generateTimecards(employee, startDate, endDate) {
    const timecards = [];
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        const dayOfWeek = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'][currentDate.getDay()];
        const schedule = employee.schedule[dayOfWeek];
        if (schedule) {
            const [startHour, startMinute] = schedule.start.split(':');
            const [endHour, endMinute] = schedule.end.split(':');
            const checkIn = new Date(currentDate);
            checkIn.setHours(parseInt(startHour), parseInt(startMinute) - Math.floor(Math.random() * 5) - 1, Math.floor(Math.random() * 60));
            const checkOut = new Date(currentDate);
            checkOut.setHours(parseInt(endHour), parseInt(endMinute) + Math.floor(Math.random() * 4) + 1, Math.floor(Math.random() * 60));
            timecards.push({
                date: currentDate.toISOString().split('T')[0],
                checkIn: checkIn.toTimeString().slice(0, 8),
                checkOut: checkOut.toTimeString().slice(0, 8)
            });
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
    return timecards;
}

function generatePDF(employee, timecards) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Agregar datos de la empresa y del empleado
    doc.setFontSize(18);
    doc.text(currentCompany.name, 20, 20);
    doc.setFontSize(12);
    doc.text(`CIF: ${currentCompany.cif}`, 20, 30);
    doc.text(`Dirección: ${currentCompany.address}, ${currentCompany.postalCode} ${currentCompany.city}`, 20, 40);
    doc.text(`Empleado: ${employee.name}`, 20, 50);
    doc.text(`DNI: ${employee.dni}`, 20, 60);
    doc.text(`Número de Seguridad Social: ${employee.socialSecurity}`, 20, 70);

    // Crear tabla de fichajes
    const tableData = timecards.map(timecard => [timecard.date, timecard.checkIn, timecard.checkOut]);
    doc.autoTable({
        startY: 80,
        head: [['Fecha', 'Hora de Entrada', 'Hora de Salida']],
        body: tableData,
    });

    // Guardar el PDF
    doc.save('fichajes.pdf');
}

// Inicialización de la aplicación
displayCompanies();
</script>
</body></html>
